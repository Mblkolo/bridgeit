<!DOCTYPE html>
<html ng-app="bridgeitApp">
<head>
    <title>websocket client</title>
    <link href="style.css" rel="stylesheet" />
    <script type="text/javascript">
        var Bag = localStorage;
    </script>
</head>
<body>
    <div ng-controller="areaController" ng-switch="model.area">
        <div ng-switch-default>
            <h3>Великое ничто!</h3>
            <div>
                Всё начинается с великого ничто, клиент обращается к серверу и пытается понять где он.
                <br />
                Для этого нужна сессия, если сессии нет, то всё понятно, нужно аутентифицироваться, но если она есть и протухла?
                <br />
                Да не важно, в любом случае первым запросом идёт присоединение к серверу и передача идентификатора сессии. И получение его же.
            </div>
        </div>

        <div ng-switch-when="welcome" ng-controller="welcomeAreaController">
            <div ng-show="!model.errorMessage">
                <div>Ты кто такой?</div>
                <input type="text" ng-model="model.userName" />
                <input type="submit" value="это я" ng-click="model.onLogin()">
            </div>
            <div ng-show="model.errorMessage">
                <span>{{model.errorMessage}}</span>
                <button ng-click="model.onCloseErrorMessage()">я исправлюсь...</button>
            </div>
        </div>

        <div ng-switch-when="rooms">
            <input type="submit" value="Создать игру">
        </div>
        <button ng-click="model.area = 'welcome'" >ok da?</button>
    </div>


    <script src="Scripts/angular.js" type="text/javascript"></script>

    <script type="text/javascript">
        var __app = angular.module('bridgeitApp', []);

        __app.controller('areaController', ['$scope', 'socketConnection', 'welcomeStateService', 'defaultStateService',
                function ($scope, socketConnection, welcomeStateService, defaultStateService) {

            console.log('areaController created');

            var __currentState = welcomeStateService;

            //Текущая локация, сообщения из других локаций игнорируются
            var __currentState = defaultStateService;

            var __states = {};
            __states[defaultStateService.area] = defaultStateService;
            __states[welcomeStateService.area] = welcomeStateService;
            //__states[RoomsState.area] = RoomsState;

            var systemRoute = function (data) {
                if (data.type == "setSessionId")
                    Bag.setItem("session", data.value);

                if (data.type == "failJoin") {
                    __currentState.leave();
                    __currentState = __states[welcomeStateService.area];
                    __currentState.enter();
                }

                if (data.type == "changeArea") {
                    __currentState.leave();
                    __currentState = __states[data.value];
                    $scope.model.area = __currentState.area;
                    __currentState.enter();
                }
            }

            socketConnection.handler = function(data)
            {
                if (data.area === 'system')
                    systemRoute(data);
                else if (data.area === __currentState.area)
                    __currentState.route(data);
            }


            $scope.model = { area: __currentState.area };

            socketConnection.open();
        }]);

        __app.controller('welcomeAreaController', ['$scope', function ($scope) {
            console.log('welcomeAreaController created');

            var __model = {
                errorMessage: "ты плохой"

            };
            __model.onLogin = function () {
                //TODO логин
            };
            __model.onCloseErrorMessage = function () {
                __model.errorMessage = "";
            };

            $scope.model = __model;
        }]);

        __app.service('socketConnection', [ '$rootScope', function ( $rootScope) {
            console.log('socketConnection created');

            that = this;

            this.handler = null;

            this.send = function (data) {
                if (__ws != null)
                    __ws.send(JSON.stringify(data));
            }

            this.onMessage = function (evt) {
                console.log( evt.data );
                if (that.handler !== null) {
                    $rootScope.$apply(function(){that.handler(JSON.parse(evt.data))});
                }
            };

            this.open = function() {
                __ws = new WebSocket('ws://localhost:8181/');
                console.log('.. connection started');

                __ws.onopen = function () {
                    console.log('.. connection open');
                    that.send({ area: "system", type: "join", value: Bag.getItem('session') });
                };
                __ws.onclose = function () { console.log('.. connection closed'); }; //И тут тоже больше ничего полезного
                __ws.onmessage = that.onMessage;
            }


        }]);

        __app.service('welcomeStateService', ['socketConnection', function (socketConnection) {
            console.log('welcomeStateService created');
            
            this.area = 'welcome';
            this.route = function (data) {
                console.log(data);
            };
            this.leave = function () { };
            this.enter = function () { };
        }]);

        __app.service('defaultStateService', ['socketConnection', function (socketConnection) {
            console.log('defaultStateService created');

            this.area = 'default';
            this.route = function (data) {
                console.log(data);
            };
            this.leave = function () { };
            this.enter = function () { };
        }]);



    </script>
</body>
</html>
