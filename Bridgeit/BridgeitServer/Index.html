<!DOCTYPE html>
<html>
<head>
    <title>websocket client</title>
    <link href="style.css" rel="stylesheet" />
    <script type="text/javascript">

        var WsImpl = window.WebSocket || window.MozWebSocket;
        var Document = document;
        var GetById = function (id) { return Document.getElementById(id); };
        var Bag = localStorage;

        var start = function () {
            var Log = GetById('LogArea');

            var Socket = function () {
                var __instance = {};
                var __ws = null;

                function send(message) {
                    if (__ws != null)
                        __ws.send(message);
                }

                function open() {
                    __ws = new WsImpl('ws://localhost:8181/');
                    Log.innerHTML += '.. connection started<br/>';
                    __ws.onopen = function () {
                        Log.innerHTML += '.. connection open<br/>';
                        __ws.send(JSON.stringify({area: "system", type: "join", value: Bag.getItem('session') }));
                    };
                    __ws.onclose = function () { Log.innerHTML += '.. connection closed<br/>'; }; //И тут тоже больше ничего полезного
                    __ws.onmessage = function (evt) {
                        Log.innerHTML += evt.data + '<br/>';
                        if (__instance.onmessage)
                            __instance.onmessage(evt.data);

                    };
                }

                __instance.send = send;
                __instance.open = open;
                __instance.onmessage = null;

                return __instance;
            }();

            var DefaultState = function () {
                function route(data) {

                }
                function leave() {
                    GetById('defaultText').className = 'hide';
                }

                function enter() {
                    GetById('defaultText').className = '';
                }

                return {
                    route: route,
                    leave: leave,
                    enter: enter,
                    area: "default"
                };
            }();

            var WelcomeState = function () {
                GetById('loginForm').addEventListener('submit', function (e) {
                    e.preventDefault();

                    var __userName = GetById('sendText').value;
                    Socket.send(JSON.stringify({area: "welcome", type: "login", session: Bag.getItem("session"), value: __userName }));
                });
                GetById('loginForm_clearError').addEventListener('click', function (e) {
                    e.preventDefault();
                    GetById('loginForm_error').className = 'hide';
                    GetById('loginForm').className = 'show';
                });

                function route(data) {
                    if (data.type == "showError") {
                        GetById('loginForm_errorMessage').textContent = data.value;
                        GetById('loginForm_error').className = '';
                        GetById('loginForm').className = '';
                    }
                }
                function leave() {
                    GetById('loginForm').className = '';
                }

                function enter() {
                    GetById('loginForm').className = 'show';
                }

                return {
                    route: route,
                    leave: leave,
                    enter: enter,
                    area: "welcome"
                };
            }();
            

            var RoomsState = function () {
                function route(data) {
                    if(data.type == 'roomsList') {
                        //TODO отработать получение списка комнат
                        //Гарантируется что все измения придут через updateRoomsList
                    }

                    if (data.type == 'updateRoomsList') {
                        //TODO отработать обновление списка комнат
                        //Если комната создана этим же игроком, то она в общем списке не отображется а висит сверхку
                        //Главная особенность в том, что её можно удалить, удалять чужие комнаты нельзя
                        //Можно пересоздать свою, тогда она заменится
                        //Нельзя присоедениться к себе :)
                    }
                }
                function leave() {
                    GetById('roomArea').className = 'hide';
                }

                function enter() {
                    GetById('roomArea').className = '';
                    //Нам нужен список чатов
                    Socket.send(JSON.stringify({ type: "getRooms", session: Bag.getItem("session")}));
                }

                return {
                    route: route,
                    leave: leave,
                    enter: enter,
                    area: "rooms"
                };
            }();

            var Br = function () {
                //Текущая локация, сообщения из других локаций игнорируются
                var __currentState = DefaultState;

                var __states = {};
                __states[DefaultState.area] = DefaultState;
                __states[WelcomeState.area] = WelcomeState;
                __states[RoomsState.area] = RoomsState;

                function systemRoute(data) {
                    if (data.type == "setSessionId")
                        Bag.setItem("session", data.value);

                    if (data.type == "failJoin") {
                        __currentState.leave();
                        __currentState = __states[WelcomeState.area];
                        __currentState.enter();
                    }

                    if (data.type == "changeArea") {
                        __currentState.leave();
                        __currentState = __states[data.value];
                        __currentState.enter();
                    }
                }

                function route(message) {
                    var __data = JSON.parse(message);
                    if (__data.area == 'system')
                        systemRoute(__data);
                    else if (__data.area == __currentState.area)
                        __currentState.route(__data);
                };

                //Запускается после обновления страницы, ну или когда мы в панике
                function start() {
                    Socket.onmessage = route;
                    Socket.open();
                }

                return { start: start };
            }();

            Br.start();
        };
        window.onload = start;
    </script>
</head>
<body>
    <div id="defaultText">
        <h3>Великое ничто!</h3>
        <div>
            Всё начинается с великого ничто, клиент обращается к серверу и пытается понять где он.
            <br />
            Для этого нужна сессия, если сессии нет, то всё понятно, нужно аутентифицироваться, но если она есть и протухла?
            <br />
            Да не важно, в любом случае первым запросом идёт присоединение к серверу и передача идентификатора сессии. И получение его же.
        </div>
    </div>
    <form id="loginForm" action="Index.html">
        <div>Ты кто такой?</div>
        <input id="sendText" type="text" />
        <input type="submit" value="это я">
    </form>
    <div id="loginForm_error" class="hide">
        <span id="loginForm_errorMessage"></span>
        <button id="loginForm_clearError">я исправлюсь...</button>
    </div>
    <form id="exitForm">
        <input id="exitButton" type="submit" value="выйти" />
    </form>
    <div id="roomArea" class="hide">Видешь список игр? А он есть</div>

    <pre id="LogArea"></pre>
</body>
</html>
